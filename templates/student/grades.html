{% extends "base.html" %}

{% block title %}My Grades - School Management System{% endblock %}

{% block main_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-line me-2"></i>
        My Grades
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary">
            <i class="fas fa-download me-2"></i>
            Download Report
        </button>
    </div>
</div>

<!-- Filter Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Subject</label>
                        <select class="form-select">
                            <option value="">All Subjects</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="english">English</option>
                            <option value="science">Science</option>
                            <option value="history">History</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Exam Type</label>
                        <select class="form-select">
                            <option value="">All Types</option>
                            <option value="quiz">Quiz</option>
                            <option value="assignment">Assignment</option>
                            <option value="midterm">Midterm</option>
                            <option value="final">Final Exam</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Academic Year</label>
                        <select class="form-select">
                            <option value="2024-25">2024-25</option>
                            <option value="2023-24">2023-24</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-primary">
                                <i class="fas fa-filter me-2"></i>
                                Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Grades Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-2x text-success mb-2"></i>
                <h5 class="card-title">85.5%</h5>
                <p class="card-text text-muted">Overall Average</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-medal fa-2x text-warning mb-2"></i>
                <h5 class="card-title">A-</h5>
                <p class="card-text text-muted">Current Grade</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                <h5 class="card-title">12</h5>
                <p class="card-text text-muted">Class Rank</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                <h5 class="card-title">{{ grades|length }}</h5>
                <p class="card-text text-muted">Total Assessments</p>
            </div>
        </div>
    </div>
</div>

<!-- Grades Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Grade Details</h5>
            </div>
            <div class="card-body">
                {% if grades %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Subject</th>
                                <th>Exam Type</th>
                                <th>Marks Obtained</th>
                                <th>Total Marks</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                                <th>Teacher</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grade in grades %}
                            <tr>
                                <td>{{ grade.exam_date.strftime('%Y-%m-%d') if grade.exam_date else 'N/A' }}</td>
                                <td>
                                    <strong>{{ grade.subject.name if grade.subject else 'N/A' }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ grade.exam_type.title() }}</span>
                                </td>
                                <td>{{ grade.marks_obtained }}</td>
                                <td>{{ grade.total_marks }}</td>
                                <td>
                                    {% set percentage = (grade.marks_obtained / grade.total_marks * 100) if grade.total_marks > 0 else 0 %}
                                    <strong>{{ "%.1f"|format(percentage) }}%</strong>
                                </td>
                                <td>
                                    {% if percentage >= 90 %}
                                        <span class="badge bg-success">A+</span>
                                    {% elif percentage >= 80 %}
                                        <span class="badge bg-success">A</span>
                                    {% elif percentage >= 70 %}
                                        <span class="badge bg-primary">B</span>
                                    {% elif percentage >= 60 %}
                                        <span class="badge bg-warning">C</span>
                                    {% elif percentage >= 50 %}
                                        <span class="badge bg-orange">D</span>
                                    {% else %}
                                        <span class="badge bg-danger">F</span>
                                    {% endif %}
                                </td>
                                <td>{{ grade.teacher.user.first_name if grade.teacher else 'N/A' }} {{ grade.teacher.user.last_name if grade.teacher else '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No grades available</h5>
                    <p class="text-muted">Your grades will appear here once teachers enter them.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Subject-wise Performance Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Subject-wise Performance</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Sample data for the chart
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Mathematics', 'English', 'Science', 'History', 'Geography'],
        datasets: [{
            label: 'Average Score (%)',
            data: [85, 78, 92, 76, 88],
            backgroundColor: [
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ],
            borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(255, 99, 132, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
</script>
{% endblock %}